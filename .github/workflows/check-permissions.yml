name: æ£€æŸ¥æ–‡ä»¶å¤¹æƒé™

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  check-folder-permissions:
    runs-on: ubuntu-latest
    name: æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦åªä¿®æ”¹äº†è‡ªå·±çš„æ–‡ä»¶å¤¹
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è·å–å˜æ›´çš„æ–‡ä»¶
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          23åŒºå—é“¾*ç­_*_*/**
    
    - name: æ£€æŸ¥æƒé™
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "æ£€æµ‹åˆ°ä»¥ä¸‹æ–‡ä»¶å‘ç”Ÿå˜æ›´:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"
        
        # è·å–æäº¤è€…ä¿¡æ¯ï¼ˆä»PRæˆ–commitä¸­ï¼‰
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          AUTHOR="${{ github.event.pull_request.user.login }}"
          echo "PRä½œè€…: $AUTHOR"
        else
          AUTHOR="${{ github.actor }}"
          echo "æäº¤è€…: $AUTHOR"
        fi
        
        # æ£€æŸ¥æ¯ä¸ªå˜æ›´çš„æ–‡ä»¶
        violation_found=false
        
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "æ£€æŸ¥æ–‡ä»¶: $file"
          
          # æå–æ–‡ä»¶å¤¹åç§°ï¼ˆå­¦ç”Ÿæ–‡ä»¶å¤¹æ ¼å¼ï¼š23åŒºå—é“¾XXç­_å­¦å·_å§“åï¼‰
          folder_name=$(echo "$file" | cut -d'/' -f1)
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯å­¦ç”Ÿæ–‡ä»¶å¤¹
          if [[ $folder_name =~ ^23åŒºå—é“¾[0-9]+ç­_[0-9]+_.+$ ]]; then
            echo "è¿™æ˜¯å­¦ç”Ÿæ–‡ä»¶å¤¹: $folder_name"
            
            # æå–å­¦å·
            student_id=$(echo "$folder_name" | sed -n 's/^23åŒºå—é“¾[0-9]\+ç­_\([0-9]\+\)_.*/\1/p')
            echo "å­¦å·: $student_id"
            
            # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„æƒé™æ£€æŸ¥é€»è¾‘
            # ä¾‹å¦‚ï¼šæ£€æŸ¥GitHubç”¨æˆ·åæ˜¯å¦ä¸å­¦å·åŒ¹é…
            # æˆ–è€…ç»´æŠ¤ä¸€ä¸ªå­¦å·åˆ°GitHubç”¨æˆ·åçš„æ˜ å°„è¡¨
            
            echo "âœ… æ–‡ä»¶ $file åœ¨å…è®¸çš„å­¦ç”Ÿæ–‡ä»¶å¤¹ä¸­"
          else
            echo "âŒ æ£€æµ‹åˆ°å¯¹éå­¦ç”Ÿæ–‡ä»¶å¤¹çš„ä¿®æ”¹: $file"
            echo "å­¦ç”Ÿåªèƒ½ä¿®æ”¹è‡ªå·±çš„æ–‡ä»¶å¤¹ï¼ˆæ ¼å¼ï¼š23åŒºå—é“¾XXç­_å­¦å·_å§“åï¼‰"
            violation_found=true
          fi
        done
        
        if [ "$violation_found" = true ]; then
          echo "âŒ æƒé™æ£€æŸ¥å¤±è´¥ï¼å‘ç°è¿è§„ä¿®æ”¹ã€‚"
          echo "è¯·ç¡®ä¿åªä¿®æ”¹è‡ªå·±çš„æ–‡ä»¶å¤¹å†…å®¹ã€‚"
          exit 1
        else
          echo "âœ… æƒé™æ£€æŸ¥é€šè¿‡ï¼æ‰€æœ‰ä¿®æ”¹éƒ½åœ¨å…è®¸çš„èŒƒå›´å†…ã€‚"
        fi
    
    - name: æ£€æŸ¥æ ¹ç›®å½•æ–‡ä»¶
      run: |
        # æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†æ ¹ç›®å½•çš„é‡è¦æ–‡ä»¶
        root_files_changed=$(git diff --name-only HEAD~1 HEAD | grep -E '^(README\.md|\.gitignore|\.github/|create_.*\.py|studentInfo\.xlsx)$' || true)
        
        if [ -n "$root_files_changed" ] && [ "${{ github.actor }}" != "teacher-username" ]; then
          echo "âŒ æ£€æµ‹åˆ°å¯¹æ ¹ç›®å½•é‡è¦æ–‡ä»¶çš„ä¿®æ”¹:"
          echo "$root_files_changed"
          echo "å­¦ç”Ÿä¸å…è®¸ä¿®æ”¹è¿™äº›æ–‡ä»¶ï¼Œåªæœ‰æ•™å¸ˆå¯ä»¥ä¿®æ”¹ã€‚"
          exit 1
        fi
        
        echo "âœ… æ ¹ç›®å½•æ–‡ä»¶æ£€æŸ¥é€šè¿‡ã€‚"
    
    - name: è¾“å‡ºæ£€æŸ¥ç»“æœ
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "ğŸ‰ æ‰€æœ‰æƒé™æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼"
          echo "æ‚¨çš„ä¿®æ”¹ç¬¦åˆä»“åº“è§„åˆ™ã€‚"
        else
          echo "âŒ æƒé™æ£€æŸ¥å¤±è´¥ã€‚"
          echo "è¯·æ£€æŸ¥æ‚¨çš„ä¿®æ”¹æ˜¯å¦ç¬¦åˆä»¥ä¸‹è§„åˆ™ï¼š"
          echo "1. åªèƒ½ä¿®æ”¹è‡ªå·±çš„æ–‡ä»¶å¤¹ï¼ˆ23åŒºå—é“¾XXç­_å­¦å·_å§“åï¼‰"
          echo "2. ä¸èƒ½ä¿®æ”¹å…¶ä»–åŒå­¦çš„æ–‡ä»¶å¤¹"
          echo "3. ä¸èƒ½ä¿®æ”¹æ ¹ç›®å½•çš„é…ç½®æ–‡ä»¶"
        fi